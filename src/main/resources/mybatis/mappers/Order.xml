<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="itc.hoseo.sew.order.OrderRepository">
	<insert id="addOrder" parameterType="Order">
		<selectKey order="BEFORE" keyProperty="orderProdNo" resultType="Order">
			SELECT 
	           'P' || cast(to_char(sysdate,'YYYYMMDD') || nvl(to_char(max(substr(orderProdNo, 10))), '0000') as number) +1
	           as orderProdNo
	        FROM
	            orderProd
		</selectKey>
		INSERT INTO orderProd
		VALUES (#{orderProdNo}, #{orderNo}, #{prodNo}, #{prodAmount}, #{prodCost})	
	</insert>
	<insert id="addOrderOption" parameterType="OrderOption">
		INSERT INTO orderOption(orderProdNo, orderColor, orderSize, orderAmount)
		VALUES(#{orderProdNo}, #{orderColor}, #{orderSize}, #{orderAmount})
	</insert>
	<insert id="addOrderList" parameterType="OrderList">
		<selectKey order="BEFORE" keyProperty="orderNo" resultType="OrderList">
			SELECT 
	           'O' || cast(to_char(sysdate,'YYYYMMDD') || nvl(to_char(max(substr(orderNo, 10))), '0000') as number) +1
	           as orderNo
	        FROM
	            orderList
		</selectKey>
		INSERT INTO 
		orderList(orderNo, totalListCost, totalDeli, totalDiscount, accPoint, totalUsedPoint, totalCost, 
			memId, receiverName, receiverContact, deliZipcode, deliAddr1, deliAddr2,
			payType, orderDate)
		VALUES (#{orderNo}, #{totalListCost}, #{totalDeli}, #{totalDiscount}, #{memAccPoint}, 
			#{totalUsedPoint}, #{totalCost}, #{memId}, #{receiverName}, #{receiverContact}, 
			#{deliZipcode}, #{deliAddr1}, #{deliAddr2}, #{payType}, #{orderDate})	
	</insert>
	<resultMap type="Order" id="OrderProdMap">
		<result column="orderProdNo" property="orderProdNo"/>
		<result column="orderNo" property="orderNo"/>
		<result column="prodNO" property="prodNo"/>
		<result column="prodAmount" property="prodAmount"/>
		<result column="prodCost" property="prodCost"/>
	    <result column="prodName" property="prodName"/>
	    <result column="prodThumbName" property="prodThumbName"/>
	    <collection property="optionList" column="orderProdNo" javaType="java.util.ArrayList" ofType="OrderOption" select="getOrderOption"/>
	</resultMap>
	<select id="getOrderProd" parameterType="String" resultMap="OrderProdMap">
		SELECT op.*, p.prodName,  img.prodThumbName
		from orderProd op
		join product p
		on op.prodno = p.prodno
		join prodImage img
		on op.prodno = img.prodno
		where op.orderNo = #{orderNo}
	</select>
	<select id="getOrderOption" parameterType="String" resultType="OrderOption">
		SELECT orderProdNo, orderColor, orderSize, orderAmount
		FROM orderOption
		WHERE orderProdNo = #{orderProdNo};
	</select>
</mapper>